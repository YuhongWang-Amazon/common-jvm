# Blob/object storage.

load("//build:defs.bzl", "test_target")
load("@io_bazel_rules_kotlin//kotlin:kotlin.bzl", "kt_jvm_library")

package_group(
    name = "load_test",
    packages = [
        "//src/main/kotlin/org/wfanet/measurement/loadtest/...",
        "//src/test/kotlin/org/wfanet/measurement/loadtest/...",
    ],
)

package_group(
    name = "integration_tests",
    packages = [
        "//src/test/kotlin/org/wfanet/measurement/integration/...",
    ],
)

kt_jvm_library(
    name = "client",
    srcs = ["StorageClient.kt"],
    visibility = [
        ":__subpackages__",
        test_target(":__subpackages__"),
        ":integration_tests",
        ":load_test",
        "//src:duchy_services",
    ],
    deps = [
        "//imports/java/com/google/protobuf",
        "//imports/kotlin/kotlinx/coroutines:core",
        "//src/main/kotlin/org/wfanet/measurement/common",
    ],
)

package_group(
    name = "metric_values_service",
    packages = [
        "//src/main/kotlin/org/wfanet/measurement/service/internal/duchy/metricvalues/...",
        "//src/test/kotlin/org/wfanet/measurement/service/internal/duchy/metricvalues/...",
    ],
)

kt_jvm_library(
    name = "metric_value_store",
    srcs = ["MetricValueStore.kt"],
    visibility = [
        test_target(":__pkg__"),
        ":metric_values_service",
    ],
    deps = [
        ":client",
        "//imports/kotlin/kotlinx/coroutines:core",
    ],
)

package_group(
    name = "duchy_computations",
    packages = [
        "//src/main/kotlin/org/wfanet/measurement/duchy/mill/...",
        "//src/main/kotlin/org/wfanet/measurement/service/internal/duchy/computation/control/...",
        "//src/test/kotlin/org/wfanet/measurement/duchy/mill/...",
        "//src/test/kotlin/org/wfanet/measurement/service/internal/duchy/computation/control/...",
    ],
)

# TODO(b/164480460): Remove once db package is no longer referencing storage package.
package_group(
    name = "computation_db",
    packages = [
        "//src/main/kotlin/org/wfanet/measurement/db/duchy/computation/...",
        "//src/test/kotlin/org/wfanet/measurement/db/duchy/computation/...",
    ],
)

kt_jvm_library(
    name = "computation_store",
    srcs = ["ComputationStore.kt"],
    visibility = [
        ":computation_db",
        ":duchy_computations",
        ":integration_tests",
    ],
    deps = [
        ":client",
        "//src/main/kotlin/org/wfanet/measurement/duchy:computation_stage",
        "//src/main/proto/wfa/measurement/internal/duchy:computation_token_java_proto",
    ],
)
